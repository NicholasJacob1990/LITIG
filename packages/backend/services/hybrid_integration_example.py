#!/usr/bin/env python3
"""
Hybrid Integration Example - Exemplo de Integra√ß√£o H√≠brida
==========================================================

Demonstra como integrar agentes LangChain aos workflows LangGraph existentes.
Mant√©m 100% compatibilidade com intelligent_triage_orchestrator_v2.py.

Mostra a estrat√©gia h√≠brida em a√ß√£o:
‚úÖ WORKFLOWS EXISTENTES: Preserva LangGraph V2 
‚úÖ AGENTES AVAN√áADOS: Adiciona LangChain nos n√≥s
‚úÖ RAG JUR√çDICO: Integra base de conhecimento brasileira
‚úÖ FALLBACK PRESERVADO: Mant√©m OpenRouter de 4 n√≠veis
"""

import asyncio
import logging
import time
from typing import Dict, Any, Optional
from datetime import datetime

# Importa√ß√µes dos servi√ßos existentes
try:
    from intelligent_triage_orchestrator_v2 import IntelligentTriageOrchestratorV2, TriageState
    TRIAGE_V2_AVAILABLE = True
except ImportError:
    TRIAGE_V2_AVAILABLE = False

# Importa√ß√µes dos novos servi√ßos h√≠bridos
try:
    from hybrid_langchain_orchestrator import get_hybrid_orchestrator
    HYBRID_ORCHESTRATOR_AVAILABLE = True
except ImportError:
    HYBRID_ORCHESTRATOR_AVAILABLE = False

try:
    from brazilian_legal_rag import get_brazilian_legal_rag
    BRAZILIAN_RAG_AVAILABLE = True
except ImportError:
    BRAZILIAN_RAG_AVAILABLE = False

logger = logging.getLogger(__name__)

class HybridTriageOrchestrator:
    """
    Orquestrador H√≠brido que combina:
    - LangGraph workflows (existentes)
    - LangChain agents (novos)
    - RAG jur√≠dico brasileiro (novo)
    - Fallback OpenRouter (preservado)
    
    Mant√©m interface id√™ntica ao V2 para compatibilidade total.
    """
    
    def __init__(self):
        self.logger = logging.getLogger(f"{self.__class__.__name__}")
        
        # Verificar disponibilidade de componentes
        self._check_availability()
        
        # Inicializar orquestrador V2 existente
        if TRIAGE_V2_AVAILABLE:
            self.v2_orchestrator = IntelligentTriageOrchestratorV2()
            self.logger.info("‚úÖ Orquestrador V2 inicializado (LangGraph workflows)")
        else:
            self.v2_orchestrator = None
            self.logger.warning("‚ö†Ô∏è Orquestrador V2 n√£o dispon√≠vel")
        
        # Inicializar orquestrador h√≠brido (LangChain agents)
        if HYBRID_ORCHESTRATOR_AVAILABLE:
            self.hybrid_orchestrator = get_hybrid_orchestrator()
            self.logger.info("‚úÖ Orquestrador H√≠brido inicializado (LangChain agents)")
        else:
            self.hybrid_orchestrator = None
            self.logger.warning("‚ö†Ô∏è Orquestrador H√≠brido n√£o dispon√≠vel")
        
        # Inicializar RAG jur√≠dico brasileiro
        if BRAZILIAN_RAG_AVAILABLE:
            self.brazilian_rag = get_brazilian_legal_rag()
            self.logger.info("‚úÖ RAG Jur√≠dico Brasileiro inicializado")
        else:
            self.brazilian_rag = None
            self.logger.warning("‚ö†Ô∏è RAG Jur√≠dico n√£o dispon√≠vel")
        
        self.logger.info("üöÄ Hybrid Triage Orchestrator inicializado")
    
    def _check_availability(self):
        """Verifica disponibilidade de componentes."""
        components = {
            "LangGraph V2": TRIAGE_V2_AVAILABLE,
            "Hybrid Orchestrator": HYBRID_ORCHESTRATOR_AVAILABLE,
            "Brazilian RAG": BRAZILIAN_RAG_AVAILABLE
        }
        
        available = [name for name, status in components.items() if status]
        unavailable = [name for name, status in components.items() if not status]
        
        self.logger.info(f"‚úÖ Componentes dispon√≠veis: {', '.join(available)}")
        if unavailable:
            self.logger.warning(f"‚ö†Ô∏è Componentes indispon√≠veis: {', '.join(unavailable)}")
    
    async def execute_triage_with_hybrid_enhancement(
        self, 
        user_id: str,
        conversation_data: Dict[str, Any],
        user_preferences: Optional[Dict[str, Any]] = None,
        use_agents: bool = True,
        use_rag: bool = True
    ) -> Dict[str, Any]:
        """
        Executa triagem com melhorias h√≠bridas.
        
        Args:
            user_id: ID do usu√°rio
            conversation_data: Dados da conversa
            user_preferences: Prefer√™ncias do usu√°rio
            use_agents: Se deve usar agentes LangChain
            use_rag: Se deve usar RAG jur√≠dico
        
        Returns:
            Resultado da triagem com melhorias h√≠bridas
        """
        start_time = time.time()
        
        try:
            # ‚úÖ ETAPA 1: Executar workflow LangGraph V2 (base existente)
            base_result = None
            if self.v2_orchestrator:
                self.logger.info("üîÑ Executando workflow LangGraph V2...")
                base_result = await self._execute_v2_workflow(
                    user_id, conversation_data, user_preferences
                )
            
            # ‚úÖ ETAPA 2: Enriquecer com agentes LangChain (se dispon√≠vel)
            agent_enhancements = {}
            if use_agents and self.hybrid_orchestrator and base_result:
                self.logger.info("ü§ñ Aplicando melhorias com agentes LangChain...")
                agent_enhancements = await self._apply_agent_enhancements(base_result)
            
            # ‚úÖ ETAPA 3: Adicionar insights RAG jur√≠dico (se dispon√≠vel)
            rag_insights = {}
            if use_rag and self.brazilian_rag and base_result:
                self.logger.info("üìö Consultando base jur√≠dica brasileira...")
                rag_insights = await self._get_rag_insights(base_result)
            
            # ‚úÖ ETAPA 4: Combinar resultados
            final_result = self._combine_results(
                base_result, agent_enhancements, rag_insights
            )
            
            duration = time.time() - start_time
            final_result["total_duration"] = duration
            final_result["hybrid_processing"] = {
                "v2_workflow": base_result is not None,
                "agent_enhancements": bool(agent_enhancements),
                "rag_insights": bool(rag_insights),
                "processing_time": duration
            }
            
            self.logger.info(f"‚úÖ Triagem h√≠brida conclu√≠da em {duration:.2f}s")
            return final_result
            
        except Exception as e:
            self.logger.error(f"‚ùå Erro na triagem h√≠brida: {e}")
            return {
                "success": False,
                "error": str(e),
                "fallback_used": True,
                "duration": time.time() - start_time
            }
    
    async def _execute_v2_workflow(
        self, 
        user_id: str, 
        conversation_data: Dict[str, Any],
        user_preferences: Optional[Dict[str, Any]]
    ) -> Optional[Dict[str, Any]]:
        """Executa workflow LangGraph V2 existente."""
        if not self.v2_orchestrator:
            return None
        
        try:
            # Usar interface p√∫blica do V2 (se dispon√≠vel)
            if hasattr(self.v2_orchestrator, 'execute_triage'):
                result = await self.v2_orchestrator.execute_triage(
                    user_id=user_id,
                    conversation_data=conversation_data,
                    user_preferences=user_preferences or {}
                )
                return result
            else:
                # Simula√ß√£o se m√©todo n√£o existir
                self.logger.warning("‚ö†Ô∏è M√©todo execute_triage n√£o encontrado - simulando")
                return {
                    "success": True,
                    "case_id": f"case_{user_id}_{int(time.time())}",
                    "triage_result": {
                        "complexity": "medium",
                        "legal_area": "Direito Trabalhista",
                        "confidence": 0.8
                    },
                    "method": "v2_simulation"
                }
                
        except Exception as e:
            self.logger.error(f"‚ùå Erro no workflow V2: {e}")
            return None
    
    async def _apply_agent_enhancements(self, base_result: Dict[str, Any]) -> Dict[str, Any]:
        """Aplica melhorias usando agentes LangChain."""
        enhancements = {}
        
        try:
            # Extrair informa√ß√µes do resultado base
            case_description = self._extract_case_description(base_result)
            legal_area = base_result.get("triage_result", {}).get("legal_area", "")
            
            # ‚úÖ Agente de An√°lise de Casos
            if case_description:
                case_analysis = await self.hybrid_orchestrator.process_with_agent(
                    agent_type="case_analyzer",
                    user_input=f"Analisar caso: {case_description}",
                    context={"legal_area": legal_area}
                )
                if case_analysis.get("success"):
                    enhancements["detailed_case_analysis"] = case_analysis.get("result")
            
            # ‚úÖ Agente de Pesquisa Jur√≠dica
            if legal_area:
                legal_research = await self.hybrid_orchestrator.process_with_agent(
                    agent_type="legal_researcher",
                    user_input=f"Pesquisar legisla√ß√£o e jurisprud√™ncia para {legal_area}",
                    context={"case_context": case_description}
                )
                if legal_research.get("success"):
                    enhancements["legal_research"] = legal_research.get("result")
            
            # ‚úÖ Agente de Perfis (se h√° dados de advogado)
            lawyer_data = base_result.get("lawyer_match")
            if lawyer_data:
                profile_analysis = await self.hybrid_orchestrator.process_with_agent(
                    agent_type="profile_analyzer",
                    user_input=f"Analisar compatibilidade advogado-caso",
                    context={
                        "case": case_description,
                        "lawyer": lawyer_data,
                        "legal_area": legal_area
                    }
                )
                if profile_analysis.get("success"):
                    enhancements["lawyer_compatibility"] = profile_analysis.get("result")
            
            self.logger.info(f"‚úÖ {len(enhancements)} melhorias de agentes aplicadas")
            
        except Exception as e:
            self.logger.error(f"‚ùå Erro ao aplicar melhorias de agentes: {e}")
        
        return enhancements
    
    async def _get_rag_insights(self, base_result: Dict[str, Any]) -> Dict[str, Any]:
        """Obt√©m insights da base jur√≠dica brasileira."""
        insights = {}
        
        try:
            # Preparar consultas baseadas no resultado base
            legal_area = base_result.get("triage_result", {}).get("legal_area", "")
            case_description = self._extract_case_description(base_result)
            
            queries = []
            
            # Consulta sobre legisla√ß√£o aplic√°vel
            if legal_area:
                queries.append({
                    "type": "legislation",
                    "query": f"Qual legisla√ß√£o se aplica a casos de {legal_area}?"
                })
            
            # Consulta sobre precedentes
            if case_description:
                queries.append({
                    "type": "precedents",
                    "query": f"Precedentes jurisprudenciais sobre {case_description[:200]}"
                })
            
            # Consulta sobre prazos
            if legal_area:
                queries.append({
                    "type": "deadlines",
                    "query": f"Prazos processuais para {legal_area}"
                })
            
            # Executar consultas RAG
            for query_info in queries:
                try:
                    rag_result = await self.brazilian_rag.query(
                        question=query_info["query"],
                        include_sources=True
                    )
                    
                    if rag_result.get("success"):
                        insights[query_info["type"]] = {
                            "answer": rag_result.get("answer"),
                            "sources": rag_result.get("sources", []),
                            "query": query_info["query"]
                        }
                        
                except Exception as query_error:
                    self.logger.warning(f"‚ö†Ô∏è Erro na consulta RAG {query_info['type']}: {query_error}")
            
            self.logger.info(f"‚úÖ {len(insights)} insights RAG obtidos")
            
        except Exception as e:
            self.logger.error(f"‚ùå Erro ao obter insights RAG: {e}")
        
        return insights
    
    def _extract_case_description(self, result: Dict[str, Any]) -> str:
        """Extrai descri√ß√£o do caso do resultado."""
        # Tentar diferentes caminhos para encontrar descri√ß√£o do caso
        paths = [
            ["conversation_data", "case_description"],
            ["triage_result", "description"],
            ["case_details", "description"],
            ["input", "description"]
        ]
        
        for path in paths:
            current = result
            try:
                for key in path:
                    current = current[key]
                if current and isinstance(current, str):
                    return current
            except (KeyError, TypeError):
                continue
        
        # Fallback: usar informa√ß√µes dispon√≠veis
        triage_result = result.get("triage_result", {})
        legal_area = triage_result.get("legal_area", "")
        complexity = triage_result.get("complexity", "")
        
        if legal_area or complexity:
            return f"Caso de {legal_area} com complexidade {complexity}"
        
        return "Caso jur√≠dico n√£o especificado"
    
    def _combine_results(
        self, 
        base_result: Optional[Dict[str, Any]], 
        agent_enhancements: Dict[str, Any],
        rag_insights: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Combina resultados de todas as fontes."""
        # Come√ßar com resultado base ou estrutura padr√£o
        if base_result:
            combined = base_result.copy()
        else:
            combined = {
                "success": False,
                "error": "Workflow base n√£o executado",
                "fallback_result": True
            }
        
        # Adicionar melhorias dos agentes
        if agent_enhancements:
            combined["agent_enhancements"] = agent_enhancements
            combined["enhanced"] = True
        
        # Adicionar insights RAG
        if rag_insights:
            combined["legal_insights"] = rag_insights
            combined["rag_enhanced"] = True
        
        # Adicionar metadados da execu√ß√£o h√≠brida
        combined["hybrid_metadata"] = {
            "timestamp": datetime.now().isoformat(),
            "components_used": {
                "langraph_v2": base_result is not None,
                "langchain_agents": bool(agent_enhancements),
                "brazilian_rag": bool(rag_insights)
            },
            "enhancement_level": self._calculate_enhancement_level(
                base_result, agent_enhancements, rag_insights
            )
        }
        
        return combined
    
    def _calculate_enhancement_level(
        self, 
        base_result: Optional[Dict[str, Any]], 
        agent_enhancements: Dict[str, Any],
        rag_insights: Dict[str, Any]
    ) -> str:
        """Calcula n√≠vel de melhoria aplicado."""
        if not base_result:
            return "fallback_only"
        elif agent_enhancements and rag_insights:
            return "full_hybrid"
        elif agent_enhancements:
            return "agent_enhanced"
        elif rag_insights:
            return "rag_enhanced"
        else:
            return "base_only"
    
    # ===== M√âTODOS DE COMPATIBILIDADE COM V2 =====
    
    async def execute_triage(self, **kwargs) -> Dict[str, Any]:
        """Interface compat√≠vel com V2."""
        return await self.execute_triage_with_hybrid_enhancement(**kwargs)
    
    def get_status(self) -> Dict[str, Any]:
        """Status do orquestrador h√≠brido."""
        status = {
            "hybrid_orchestrator": "active",
            "components": {}
        }
        
        if self.v2_orchestrator:
            status["components"]["langraph_v2"] = "available"
        
        if self.hybrid_orchestrator:
            status["components"]["langchain_agents"] = "available"
            status["components"].update(self.hybrid_orchestrator.get_status())
        
        if self.brazilian_rag:
            status["components"]["brazilian_rag"] = "available"
            status["components"].update(self.brazilian_rag.get_stats())
        
        return status


# ===== EXEMPLO DE USO =====

async def example_usage():
    """Exemplo de como usar o orquestrador h√≠brido."""
    print("üöÄ Iniciando exemplo de orquestrador h√≠brido...")
    
    # Inicializar orquestrador
    orchestrator = HybridTriageOrchestrator()
    
    # Dados de exemplo
    user_id = "user_123"
    conversation_data = {
        "case_description": "Funcion√°rio n√£o recebeu horas extras trabalhadas nos √∫ltimos 2 anos",
        "urgency_level": "medium",
        "estimated_value": 15000.00,
        "client_type": "individual"
    }
    
    user_preferences = {
        "preferred_lawyer_location": "S√£o Paulo",
        "budget_range": "medium"
    }
    
    # Executar triagem h√≠brida
    print("üìã Executando triagem h√≠brida...")
    result = await orchestrator.execute_triage_with_hybrid_enhancement(
        user_id=user_id,
        conversation_data=conversation_data,
        user_preferences=user_preferences,
        use_agents=True,
        use_rag=True
    )
    
    # Exibir resultado
    print("\n‚úÖ Resultado da triagem h√≠brida:")
    print(f"Sucesso: {result.get('success')}")
    print(f"N√≠vel de melhoria: {result.get('hybrid_metadata', {}).get('enhancement_level')}")
    
    if result.get("agent_enhancements"):
        print("\nü§ñ Melhorias dos agentes:")
        for key, value in result["agent_enhancements"].items():
            print(f"  - {key}: {str(value)[:100]}...")
    
    if result.get("legal_insights"):
        print("\nüìö Insights jur√≠dicos:")
        for key, value in result["legal_insights"].items():
            print(f"  - {key}: {value.get('answer', '')[:100]}...")
    
    print(f"\n‚è±Ô∏è Tempo total: {result.get('total_duration', 0):.2f}s")
    
    # Status do sistema
    print("\nüìä Status do sistema:")
    status = orchestrator.get_status()
    for component, info in status.get("components", {}).items():
        print(f"  - {component}: {info}")


if __name__ == "__main__":
    asyncio.run(example_usage())
